<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Status - AI Hackathon Platform</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <nav class="nav-bar">
            <a href="{{ url_for('main.index') }}" class="nav-link">Home</a>
            <a href="{{ url_for('main.submit') }}" class="nav-link">Submit Repository</a>
        </nav>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="job-status">
            <h1>Job Status</h1>
            
            <div class="job-details">
                <div class="detail-group">
                    <label>Job ID:</label>
                    <span>{{ job.id }}</span>
                </div>
                
                <div class="detail-group">
                    <label>Repository:</label>
                    <span>{{ job.repo_url }}</span>
                </div>
                
                <div class="detail-group">
                    <label>Branch:</label>
                    <span>{{ job.branch }}</span>
                </div>
                
                <div class="detail-group">
                    <label>Status:</label>
                    <span class="status-badge status-{{ job.status.lower() }}" id="status-badge">{{ job.status }}</span>
                </div>
                
                <div class="detail-group">
                    <label>Submitted:</label>
                    <span>{{ job.timestamp }}</span>
                </div>

                {% if job.start_time %}
                <div class="detail-group">
                    <label>Started:</label>
                    <span>{{ job.start_time }}</span>
                </div>
                {% endif %}

                {% if job.end_time %}
                <div class="detail-group">
                    <label>Completed:</label>
                    <span>{{ job.end_time }}</span>
                </div>
                {% endif %}
            </div>

            <div class="job-logs">
                <h2>Job Logs</h2>
                <pre id="log-output" class="log-output"></pre>
            </div>
        </div>
    </div>

    <script>
        const jobId = "{{ job.id }}";
        const logOutput = document.getElementById('log-output');
        const statusBadge = document.getElementById('status-badge');
        let lastLogCount = 0;

        function updateJobStatus() {
            fetch(`/job/${jobId}`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status) {
                        statusBadge.textContent = data.status;
                        statusBadge.className = `status-badge status-${data.status.toLowerCase()}`;
                    }
                })
                .catch(error => console.error('Error fetching status:', error));
        }

        function updateLogs() {
            fetch(`/logs/${jobId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.logs && data.logs.length > lastLogCount) {
                        // Only update if there are new logs
                        logOutput.textContent = data.logs.join('\n');
                        lastLogCount = data.logs.length;
                        
                        // Auto-scroll to bottom
                        logOutput.scrollTop = logOutput.scrollHeight;
                    }
                    
                    // Continue polling if job is not completed
                    if (statusBadge.textContent !== 'Completed') {
                        setTimeout(updateLogs, 2000);
                    }
                })
                .catch(error => {
                    console.error('Error fetching logs:', error);
                    setTimeout(updateLogs, 2000);
                });
        }

        // Start polling if job is not completed
        if (statusBadge.textContent !== 'Completed') {
            updateLogs();
            // Update status every 2 seconds as well
            setInterval(updateJobStatus, 2000);
        }
    </script>
</body>
</html> 