{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="job-status">
        <h1>Job Status</h1>
        
        <div class="job-info">
            <div class="info-group">
                <label>Status:</label>
                <span class="status-badge {{ job.status.lower() }}">{{ job.status }}</span>
            </div>
            <div class="info-group">
                <label>Framework:</label>
                <span>{{ job.framework }}</span>
            </div>
            <div class="info-group">
                <label>Submitted:</label>
                <span>{{ job.timestamp }}</span>
            </div>
            {% if job.start_time %}
            <div class="info-group">
                <label>Started:</label>
                <span>{{ job.start_time }}</span>
            </div>
            {% endif %}
            {% if job.end_time %}
            <div class="info-group">
                <label>Completed:</label>
                <span>{{ job.end_time }}</span>
            </div>
            {% endif %}
        </div>

        {% if job.status == 'Completed' %}
        <div class="job-actions">
            <a href="{{ url_for('main.download_results', job_id=job_id) }}" class="btn btn-primary">Download Results</a>
        </div>
        {% endif %}

        <div class="job-logs">
            <h2>Job Logs</h2>
            <div class="log-output" id="logOutput">
                {% for log in job.logs %}
                <div class="log-line">{{ log }}</div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
let isPolling = true;

function updateLogs() {
    if (!isPolling) return;
    
    fetch(`/logs/{{ job_id }}`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        const logOutput = document.getElementById('logOutput');
        logOutput.innerHTML = data.logs.map(log => `<div class="log-line">${log}</div>`).join('');
    })
    .catch(error => console.error('Error fetching logs:', error));
}

function updateStatus() {
    if (!isPolling) return;
    
    fetch(`/job/{{ job_id }}/status`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        const statusBadge = document.querySelector('.status-badge');
        if (statusBadge) {
            statusBadge.textContent = data.status;
            statusBadge.className = `status-badge ${data.status.toLowerCase()}`;
            
            // Stop polling if job is completed or failed
            if (data.status === 'Completed' || data.status === 'Failed') {
                isPolling = false;
                console.log('Job finished, stopping polling');
            }
        }
    })
    .catch(error => console.error('Error fetching status:', error));
}

// Update logs and status every 2 seconds
setInterval(updateLogs, 2000);
setInterval(updateStatus, 2000);
</script>
{% endblock %} 