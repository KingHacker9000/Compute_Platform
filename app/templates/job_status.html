{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="job-status">
        <h1>Job Status</h1>
        
        <div class="job-details">
            <div class="detail-group">
                <label>Repository:</label>
                <span>{{ job.repo_url }}</span>
            </div>
            
            <div class="detail-group">
                <label>Branch:</label>
                <span>{{ job.branch }}</span>
            </div>
            
            <div class="detail-group">
                <label>Framework:</label>
                <span class="framework-badge framework-{{ job.framework.lower() if job.framework else 'python' }}">
                    {{ job.framework.title() if job.framework else 'Python' }}
                </span>
            </div>
            
            <div class="detail-group">
                <label>Status:</label>
                <span class="status-badge status-{{ job.status.lower() }}" id="status-badge">{{ job.status }}</span>
            </div>
            
            <div class="detail-group">
                <label>Exit Code:</label>
                <span class="exit-code {{ 'exit-success' if job.exit_code == 0 else 'exit-error' }}">
                    {{ job.exit_code if job.exit_code is not none else 'N/A' }}
                </span>
            </div>
        </div>

        <div class="job-logs">
            <h2>Job Logs</h2>
            <div class="log-output" id="log-output">
                {% for log in job.logs %}
                <div class="log-line">{{ log }}</div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
let lastLogCount = {{ job.logs|length }};
let isPolling = true;

console.log('Initial log count:', lastLogCount);

function updateLogs() {
    if (!isPolling) return;
    
    console.log('Fetching logs...');
    fetch('/logs/{{ job.id }}', {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log('Received data:', data);
        const logOutput = document.getElementById('log-output');
        const statusBadge = document.getElementById('status-badge');
        
        // Update status if it changed
        if (statusBadge.textContent !== data.status) {
            console.log('Status changed:', data.status);
            statusBadge.textContent = data.status;
            statusBadge.className = `status-badge status-${data.status.toLowerCase()}`;
        }
        
        // Only append new logs
        if (data.logs.length > lastLogCount) {
            console.log(`Adding ${data.logs.length - lastLogCount} new log lines`);
            for (let i = lastLogCount; i < data.logs.length; i++) {
                const logLine = document.createElement('div');
                logLine.className = 'log-line';
                logLine.textContent = data.logs[i];
                logOutput.appendChild(logLine);
                // Auto-scroll to bottom
                logOutput.scrollTop = logOutput.scrollHeight;
            }
            lastLogCount = data.logs.length;
        }
        
        // Stop polling if job is completed or failed
        if (data.status === 'Completed' || data.status === 'Failed') {
            console.log('Job finished, stopping polling');
            isPolling = false;
        }
    })
    .catch(error => {
        console.error('Error fetching logs:', error);
        isPolling = false;
    });
}

// Start polling immediately
updateLogs();

// Poll every 2 seconds
setInterval(updateLogs, 2000);
</script>
{% endblock %} 